#!/usr/bin/env ruby
#
# npm2rpm
#
#  Generate spec from Nodejs NPM
#
# Copyright (c) 2013 Klaus KÃ¤mpf <kkaempf@suse.de>
#
# Licensed under the Ruby license
#

require 'rubygems'

$:.push(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'npm2rpm'

options = Npm2Rpm::Options.new

dir_exists = false

unless options.package
  Dir.new(".").each do |f|
    if f =~ /^(.*)\.tgz$/
      split = $1.split "-"
      v = split.pop
      n = split.join "-"
      options.package = "#{n}@#{v}"
      dir_exists = true
      break
    end
  end
  abort 'Missing package argument' unless options.package;
end

metadata = Npm2Rpm::Metadata.new options.package, options.version

spec = Npm2Rpm::Spec.new(metadata)

unless dir_exists
  begin
    Dir.mkdir spec.name
  rescue Errno::EEXIST
  end
  Dir.chdir spec.name
end

spec.write
changes = Npm2Rpm::Changes.new(spec.name, metadata, options)
changes.write
Npm2Rpm::Rpmlintrc.new(spec.name, metadata, options).write

if dir_exists
  Kernel.system "osc ci -m 'spec cleanup'"
else
  Dir.chdir ".."
  Kernel.system "osc add #{spec.name}"
  Kernel.system "osc ci #{spec.name} -m '#{changes.message}'"
end
